# SPDX-License-Identifier:	MPL-2.0

if(${OPUSARIUM_CMAKE_AMD64_INCGUARD})
    return()
endif()
set(OPUSARIUM_CMAKE_AMD64_INCGUARD TRUE)

if(${OPUSARIUM_CMAKE_ENVIRONMENT_NAME} STREQUAL "linux")
    file(READ "/proc/cpuinfo" OPUSARIUM_CMAKE_AMD64_RAWDATA)
    string(REGEX REPLACE ".*flags[ \t]*:[ \t]+([ a-zA-Z0-9\t\n_-]+).*" "\\1"
        OPUSARIUM_CMAKE_AMD64_FLAGS ${OPUSARIUM_CMAKE_AMD64_RAWDATA})
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "rtm" OPUSARIUM_CMAKE_AMD64_RTM)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "avx" OPUSARIUM_CMAKE_AMD64_AVX)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "avx2" OPUSARIUM_CMAKE_AMD64_AVX2)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "bmi1" OPUSARIUM_CMAKE_AMD64_BMI1)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "bmi2" OPUSARIUM_CMAKE_AMD64_BMI2)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "abm" OPUSARIUM_CMAKE_AMD64_ABM)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "popcnt" OPUSARIUM_CMAKE_AMD64_POPCNT)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "cx16" OPUSARIUM_CMAKE_AMD64_CMPXCHG16B)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "constant_tsc" OPUSARIUM_CMAKE_AMD64_CSTCLK)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "nonstop_tsc" OPUSARIUM_CMAKE_AMD64_NSTCLK)
    string(FIND ${OPUSARIUM_CMAKE_AMD64_FLAGS} "tsc_adjust" OPUSARIUM_CMAKE_AMD64_ADJCLK)
else()
    message(WARNING "Unsupported AMD64-ENV: ${OPUSARIUM_CMAKE_ENVIRONMENT_NAME}")
endif()

set(OPUSARIUM_CMAKE_AMD64_EXTLST)

if(NOT ${OPUSARIUM_CMAKE_AMD64_RTM} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "rtm")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_RTM)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_RTM)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_AVX} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "avx")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_AVX)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_AVX)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_AVX2} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "avx2")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_AVX2)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_AVX2)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_BMI1} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "bmi1")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_BMI1)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_BMI1)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_BMI2} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "bmi2")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_BMI2)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_BMI2)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_ABM} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "abm")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_ABM)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_ABM)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_POPCNT} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "popcnt")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_POPCNT)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_POPCNT)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_CMPXCHG16B} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "cmpxchg16b")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_CMPXCHG16B)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_CMPXCHG16B)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_CSTCLK} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "cstclk")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_CSTCLK)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_CSTCLK)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_NSTCLK} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "nstclk")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_NSTCLK)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_NSTCLK)
    endif()
endif()
if(NOT ${OPUSARIUM_CMAKE_AMD64_ADJCLK} EQUAL "-1")
    list(APPEND OPUSARIUM_CMAKE_AMD64_EXTLST "adjclk")
    if(${CMAKE_VERSION} VERSION_LESS "3.12.0")
        add_definitions(-DOPUSARIUM_BUILD_AMD64_ADJCLK)
    else()
        add_compile_definitions(OPUSARIUM_BUILD_AMD64_ADJCLK)
    endif()
endif()

message("-- Opusarium AMD64 extensions: ${OPUSARIUM_CMAKE_AMD64_EXTLST}")